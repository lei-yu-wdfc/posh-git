<Project DefaultTargets="Test" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<UsingTask TaskName="Gallio" AssemblyFile="$(ProgramW6432)\Gallio\bin\Gallio.MsBuildTasks.dll" />
	
	<PropertyGroup>
		<Framework>Wonga.QA.Framework</Framework>
		<Tests>Wonga.QA.Tests</Tests>
		<Generators>Wonga.QA.Generators</Generators>
	</PropertyGroup>
	
	<PropertyGroup>
		<Root>$(MSBuildProjectDirectory)\..</Root>
		<Src>$(Root)\src</Src>
		<Bin>$(Root)\bin</Bin>
	</PropertyGroup>
	
	<PropertyGroup>
		<TestDependencies>
			Config;
			Build;
			Merge;
		</TestDependencies>
	</PropertyGroup>
	
	<Target Name="Config">
		<Exec Command="SETX SUT $(SUT)" />
		<Exec Command="SETX AUT $(AUT)" />
	</Target>
	
	<Target Name="Build">
		<ItemGroup>
			<Projects Include="$(Src)\$(Framework)\$(Framework).sln" />
			<Projects Include="$(Src)\$(Tests)\$(Tests).sln" />
			<Projects Include="$(Src)\$(Generators)\$(Generators).sln" />
		</ItemGroup>
		<MSBuild Projects="@(Projects)" />
	</Target>
	
	<Target Name="Merge">
		<ItemGroup>
			<Command Include='"$(MSBuildProgramFiles32)\Microsoft\ILMerge\ILMerge.exe"' />
			<Command Include='/targetplatform:v4,"$(MSBuildToolsPath)"' />
			<Command Include='/wildcards' />
			<Command Include='/out:"$(Bin)\$(Tests)\$(Tests).dll"' />
			<Command Include='"$(Bin)\$(Tests)\$(Tests).*.dll"' />
		</ItemGroup>
		<Exec Command="@(Command, ' ')" />
	</Target>
	
	<Target Name="Test" DependsOnTargets="$(TestDependencies)">
		<Gallio
			Files="$(Bin)\$(Tests)\$(Tests).dll"
			Filter="Category: $(AUT)"
			ReportTypes="xml"
			ReportDirectory="$(Bin)\$(Tests).Report"
		/>
	</Target>
</Project>
