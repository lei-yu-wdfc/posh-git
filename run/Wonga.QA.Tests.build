<Project DefaultTargets="Default" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<UsingTask TaskName="Gallio" AssemblyFile="$(ProgramW6432)\Gallio\bin\Gallio.MsBuildTasks.dll" />
	<PropertyGroup>
		<BaseDirectory>$(MSBuildProjectDirectory)</BaseDirectory>
	</PropertyGroup>
	<Import Project="$(BaseDirectory)\buildscripts\base.targets"/>
	
	<Target Name="Merge">
		<ItemGroup>
			<Exclude Include="$(Bin)\$(Tests).Core.dll" />
			<Exclude Include="$(Bin)\$(Tests).Meta.dll" />
			<Exclude Include="$(Bin)\$(Tests).Ui.dll" />
			<Exclude Include="$(Bin)\$(Tests).Ui.Mobile.dll" />
			<Exclude Include="$(Bin)\$(Tests).Migration.dll" />
			<Command Include='"$(MSBuildProgramFiles32)\Microsoft\ILMerge\ILMerge.exe"' />
			<Command Include="/targetplatform:v4,$(MSBuildToolsPath)" />
			<Command Include="/out:$(Bin)\$(Tests).dll" />
			<Command Include="$(Bin)\$(Tests).Core.dll" />
			<Command Include="$(Bin)\$(Tests).*.dll" Exclude="@(Exclude)" />
		</ItemGroup>
		<Exec Command="@(Command, ' ')" />
	</Target>
	
	<Target Name="Test">
		<ItemGroup>
			<Split Include="$(Files.Split(';'))" />
			<Files Include="$(Bin)\$(Tests).dll" Condition="'$(Files)'==''" />
			<Files Include="$(Bin)\$(Tests).%(Split.Identity).dll" Condition="'$(Files)'!=''" />
		</ItemGroup>
		<Gallio
			Filter="$(TestFilter)"
			Files="@(Files)"
			ReportTypes="html-condensed;xml"
			ReportNameFormat="$(Tests).Report"
			ReportDirectory="$(Bin)\$(Tests).Report"
		/>
	</Target>
	
	<Target Name="SanityTest">
		<CallTarget Targets="Config;Build;Merge;PreGenerateSerializers" />
		<MsBuild Projects="$(MSBuildProjectFullPath)" Targets="Test;ConvertReports" Properties="Files=Meta;TestTarget=$(TestTarget)" RunEachTargetSeparately="true"/>
		<MsBuild Projects="$(MSBuildProjectFullPath)" Targets="Test;ConvertReports" Properties="TestTarget=$(TestTarget);TestFilter=Category:CoreTest"  RunEachTargetSeparately="true"/>
	</Target>
	
	<Target Name="ConvertReports">
		<Exec Command="$(Bin)\ConvertGallioReportToHtml\ConvertGallioReportToHtml.exe &quot;$(Bin)\$(Tests).Report\$(Tests).Report.xml&quot; &quot;$(Bin)\$(Tests).Report\$(Tests).Report.Converted.html&quot; html"/>
		<Exec Command="$(Bin)\ConvertGallioReportToHtml\ConvertGallioReportToHtml.exe &quot;$(Bin)\$(Tests).Report\$(Tests).Report.xml&quot; &quot;$(Bin)\$(Tests).Report\$(Tests).Report.csv&quot; csv"/>
	</Target>
	
	<Target Name="Default">
		<CallTarget Targets="Config;Build;Merge;PreGenerateSerializers" />
		<MsBuild Condition="'$(Files)'==''" Projects="$(MSBuildProjectFullPath)" Targets="Test;ConvertReports" Properties="Files=Meta" RunEachTargetSeparately="true"/>
		<CallTarget Targets="Test;ConvertReports" RunEachTargetSeparately="true" />
	</Target>
</Project>
